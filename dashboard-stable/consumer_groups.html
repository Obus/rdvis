<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>SB Admin 2 - Bootstrap Admin Theme</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="css/plugins/metisMenu/metisMenu.min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <!--<link href="css/plugins/dataTables.bootstrap.css" rel="stylesheet">-->

    <!-- Custom CSS -->
    <link href="css/sb-admin-2.css" rel="stylesheet">
    <link href="jq-datatables/jquery.dataTables.css" rel="stylesheet">
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.4/js/jquery.dataTables.min.js"></script>

    <!-- Custom Fonts -->
    <link href="font-awesome-4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <script type="text/javascript" src="d3/d3.js"></script>
    <script type="text/javascript" src="d3/d3.layout.js"></script>
    <style type="text/css">
          .node circle {
            cursor: pointer;
            fill: #fff;
            stroke: steelblue;
            stroke-width: 1.5px;
          }

          .node text {
            font-size: 11px;
          }

          path.link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
          }
    </style>


</head>

<body>

    <div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">SB Admin v2.0</a>
            </div>
            <!-- /.navbar-header -->
            <!-- /.navbar-top-links -->

            <div class="navbar-default sidebar" role="navigation">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                        <li class="sidebar-search">
                            <div class="input-group custom-search-form">
                                <input type="text" class="form-control" placeholder="Search...">
                                <span class="input-group-btn">
                                <button class="btn btn-default" type="button">
                                    <i class="fa fa-search"></i>
                                </button>
                            </span>
                            </div>
                            <!-- /input-group -->
                        </li>
                        <li>
                            <a href="index.html"><i class="fa fa-dashboard fa-fw"></i> Dashboard</a>
                        </li>
                        <li>
                            <a id="consumer_goods_tables_link" href="consumer_goods_tables.html"><i class="fa fa-table fa-fw"></i> Consumer goods tables</a>
                        </li>
                        <li>
                            <a id="consumer_cheques_link" href="consumer_cheques.html"><i class="fa fa-table fa-fw"></i> Consumer cheques</a>
                        </li>
                        <li>
                            <a сlass="active" id="consumer_groups_link" href="consumer_groups.html"><i class="fa fa-table fa-fw"></i> Consumer groups recs</a>
                        </li>
                        <li>
                            <a id="consumer_S_LG_recs" href="consumer_S_LG_recs.html"><i class="fa fa-table fa-fw"></i> Consumer Simplate and Printer recs</a>
                        </li>
                        <li>
                            <a id="recs_aggr_info" href="recs_aggr_info.html"><i class="fa fa-table fa-fw"></i>Recommendations 'offline' statistics</a>
                        </li>
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>

        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                    <h3 class="page-header">Tables</h3>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <div class="row">
                    <div class="col-lg-12">
                        <div class="page-content"></div>
                    </div>
                    <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-5">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Consumer groups counts
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div class="table-responsive" id="table-consumer-groups-count">
                            </div>
                            <!-- /.table-responsive -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                </div>
            <!--</div>-->
            <!--&lt;!&ndash; /.row &ndash;&gt;-->
            <!--<div class="row">-->
                <!-- /.col-lg-6 -->
                <div class="col-lg-3">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Consumer groups recs
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div class="table-responsive" id="table-consumer-groups-recs">
                            </div>
                        </div>
                        <!-- /.panel-body -->
                    </div>
                </div>
                <!-- /.col-lg-6 -->
            <!--</div>-->

            <!--<div class="row">-->
                <div class="col-lg-36">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Sending groups
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">
                            <div class="table-responsive" id="table-groups">
                            </div>
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-6 -->
                <div class="col-lg-6">
                </div>
                <!-- /.col-lg-6 -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="js/plugins/metisMenu/metisMenu.min.js"></script>

    <!-- DataTables JavaScript -->
    <script src="js/plugins/dataTables/jquery.dataTables.js"></script>
    <script src="js/plugins/dataTables/dataTables.bootstrap.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="js/sb-admin-2.js"></script>

    <!-- Page-Level Demo Scripts - Tables - Use for reference -->
    <script>
    $(document).ready(function() {
        $('#dataTables-example').dataTable();
    });
    </script>

<script type="text/javascript">
    var isArray = Array.isArray || function(arr) {
          return toString.call(arr) == '[object Array]';
    };

    function fill_table(div_id, json_source, sort_order) {
      d3.json(json_source, function(json) {

        if ( typeof sort_order === 'undefined' ) {
          sort_order = [0, "desc"];
        }

        array_of_columns = [];
        for (var i = 0; i < json.col_names.length; i++) {
          n = json.col_names[i];
          array_of_columns.push({
            text: n, sort_column: true
          })
        }
        array_of_data = json.data;

        table = d3.select("#" + div_id).html(null)
          .append("table")
          .attr('class', 'table table-striped table-bordered table-hover')
          .attr('id', "tbl-" + div_id)
          .attr('class', 'display')
          .attr('width', '100%')
          .attr('cellspacing', '0')

        ;
        table.append('thead').append("tr").selectAll("th").data(array_of_columns).enter()
              .append("th")
              .text(function (column) { return column.text; })
        ;
        tbody = table.append("tbody")
        ;
        var i = 1;
        rows = tbody.selectAll("tr").
          data(array_of_data).
          enter().
          append("tr").
          classed({'gradeA odd': i % 2 == 0, 'gradeA even': i++ % 2 == 0})
        ;
        rows.selectAll("td")
              .data(function (d) { return isArray(d)? d: d.data; }).enter()
              .append("td")
              .text(function (d) { return d; })
        ;
        var dtable = $("#tbl-" + div_id).DataTable({
            "pagingType": "simple",
            "pageLength": 40,
            "order" : sort_order
        });
        dtable.column(0).sort(function(x, y) {
          var c = 0
          if (x > y) {
            c = -1
          }
          if (x < y) {
            c = 1
          }
          return c;
        });
        d3.select('.page-header').text("Consumer (" + discount_card_id + ") goods recs and counts");
        d3.select('#consumer_goods_tables_link').attr('href', 'consumer_goods_tables.html?discount_card_id=' + discount_card_id);
        d3.select('#consumer_cheques_link').attr('href', 'consumer_cheques.html?discount_card_id=' + discount_card_id);
        d3.select('#consumer_groups_link').attr('href', 'consumer_groups.html?discount_card_id=' + discount_card_id);
        d3.select('#consumer_S_LG_recs').attr('href', 'consumer_S_LG_recs.html?discount_card_id=' + discount_card_id);
      });
    }
    function getParameterByName(name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
          results = regex.exec(location.search);
      return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }
    discount_card_id = getParameterByName('discount_card_id');
    //discount_card_id = '2775023854760'
    fill_table('table-consumer-groups-count', "hard_query?query='select group23, cnt from ulybka_radugi.cons_group23_count where cons='" + discount_card_id + "' '", [1, "desc"]);
    fill_table('table-consumer-groups-recs', "hard_query?query='select group23 from ulybka_radugi.cons_group23_top_recs where cons='" + discount_card_id + "' '");
    fill_table('table-groups', "hard_query?query='select group23 from ulybka_radugi.chosen_group23X ");
  </script>



    <script type="text/javascript">
        var m = [20, 120, 20, 120],
            w = window.innerWidth * 0.7 - m[1] - m[3],
            h = window.innerHeight * 0.7 - m[0] - m[2],
            i = 0,
            root;

        var tree = d3.layout.tree()
            .size([h, w]);

        var diagonal = d3.svg.diagonal()
            .projection(function(d) { return [d.y, d.x]; });

        var vis = d3.select(".page-content").append("svg:svg")
            .attr("width", w + m[1] + m[3])
            .attr("height", h + m[0] + m[2])
          .append("svg:g")
            .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

        function getParameterByName(name) {
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
              results = regex.exec(location.search);
          return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }
        discount_card_id = getParameterByName('discount_card_id');
        //discount_card_id = '2775023854760'
        d3.json("consumer_date_group_purchases?discount_card_id=" + discount_card_id, function(json) {
          root = json;
          root.x0 = h / 2;
          root.y0 = 0;

          function toggleAll(d) {
            if (d.children) {
              d.children.forEach(toggleAll);
              toggle(d);
            }
          }

          // Initialize the display to show a few nodes.
          root.children.forEach(toggleAll);
          toggle(root.children[1]);
        //  toggle(root.children[1].children[2]);
        //  toggle(root.children[9]);
        //  toggle(root.children[9].children[0]);

          update(root);
        });

        function update(source) {
          var duration = d3.event && d3.event.altKey ? 5000 : 500;

          // Compute the new tree layout.
          var nodes = tree.nodes(root).reverse();

          // Normalize for fixed-depth.
          nodes.forEach(function(d) {
            if (d.depth < 2) {
              d.y = d.depth * 180;
            }
            else {
              d.y = (d.depth - 1) * 180 + 400
            }
          });

          // Update the nodes…
          var node = vis.selectAll("g.node")
              .data(nodes, function(d) { return d.id || (d.id = ++i); });

          // Enter any new nodes at the parent's previous position.
          var nodeEnter = node.enter().append("svg:g")
              .attr("class", "node")
              .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
              .on("click", function(d) { toggle(d); update(d); });

          nodeEnter.append("svg:circle")
              .attr("r", 1e-6)
              .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

          nodeEnter.append("svg:text")
              .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
              .attr("dy", ".35em")
              .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
              .text(function(d) { return d.name; })
              .style("fill-opacity", 1e-6);

          // Transition nodes to their new position.
          var nodeUpdate = node.transition()
              .duration(duration)
              .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

          nodeUpdate.select("circle")
              .attr("r", 4.5)
              .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

          nodeUpdate.select("text")
              .style("fill-opacity", 1);

          // Transition exiting nodes to the parent's new position.
          var nodeExit = node.exit().transition()
              .duration(duration)
              .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
              .remove();

          nodeExit.select("circle")
              .attr("r", 1e-6);

          nodeExit.select("text")
              .style("fill-opacity", 1e-6);

          // Update the links…
          var link = vis.selectAll("path.link")
              .data(tree.links(nodes), function(d) { return d.target.id; });

          // Enter any new links at the parent's previous position.
          link.enter().insert("svg:path", "g")
              .attr("class", "link")
              .attr("d", function(d) {
                var o = {x: source.x0, y: source.y0};
                return diagonal({source: o, target: o});
              })
            .transition()
              .duration(duration)
              .attr("d", diagonal);

          // Transition links to their new position.
          link.transition()
              .duration(duration)
              .attr("d", diagonal);

          // Transition exiting nodes to the parent's new position.
          link.exit().transition()
              .duration(duration)
              .attr("d", function(d) {
                var o = {x: source.x, y: source.y};
                return diagonal({source: o, target: o});
              })
              .remove();

          // Stash the old positions for transition.
          nodes.forEach(function(d) {
            d.x0 = d.x;
            d.y0 = d.y;
          });
        }

        // Toggle children.
        function toggle(d) {
          if (d.children) {
            d._children = d.children;
            d.children = null;
          } else {
            d.children = d._children;
            d._children = null;
          }
        }
        d3.select('.page-header').text("Consumer (" + discount_card_id + ") groups recs & history");
    </script>

</body>

</html>
